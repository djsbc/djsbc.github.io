<html>

<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type" />
<title>永信HAC健康盃慢速壘球邀請賽 管理系統</title>

<!--<link rel="stylesheet" href="../uikit/css/uikit.docs.min.css" />-->
<link rel="stylesheet" href="../uikit/css/uikit.almost-flat.min.css" />
<script src="../js/jquery-3.1.1.min.js"></script>
<script src="../js/md5.js"></script>
<script src="../uikit/js/uikit.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!--Google-->
<script src="https://apis.google.com/js/platform.js" async defer></script>
<script src="./js/initGoogleAPI.js"></script>
<!--<meta name="google-signin-client_id" content="1068514341308-hmbh0jmrq6fdcph97tqql9v6pl1om6i0.apps.googleusercontent.com">-->

<!--custom css-->
<link rel="stylesheet" href="../css/style.css" />
<link rel="stylesheet" href="../css/table.css" />

<!--button-->
<link rel="stylesheet" href="../css/button/css/buttons.css">
<script type="text/javascript" src="../css/button/js/buttons.js"></script>
<link rel="stylesheet" href="../css/main-style.css" />
</head>

<body>

<div class="uk-width-medium-1-1 uk-container-center wrap">
	
	<div class="uk-cover-background uk-position-relative indexCoverImage" >
		<div class="uk-position-cover uk-flex uk-flex-center uk-flex-bottom">
			<div class="indexCoverTitle">永信HAC健康盃慢速壘球邀請賽 管理系統</div>
		</div>
	</div>
	
	<div id="unLogin" class="uk-width-medium-4-5 uk-container-center main" style="background-color:rgb(240,240,240); margin-top:20px;">
		<br/>
		<span class="loading-use-flexbox"><div class="loadingImg"></div></span>
		<br/>
	</div>
	
	<div id="isLogin" class="uk-width-medium-4-5 uk-container-center main" style="display:none;background-color:rgb(240,240,240); margin-top:20px;">
		<nav class="uk-navbar" style="margin-top:20px;">
			<ul id="navUL" class="uk-navbar-nav uk-hidden-small">
				<li><a href="admin.htm">管理中心首頁</a></li>
				<li><a href="admin_unfill.htm">尚未填寫匯款資料的隊伍</a></li>
				<li><a href="admin_wait.htm">正在等候審核的隊伍</a></li>
				<li><a href="admin_duplicate.htm">重複報名名單</a></li>
				<li class="uk-active"><a href="admin_accepted.htm">已通過審核的隊伍</a></li>
				<li><a href="admin_chart.htm">報名狀況報表</a></li>
				<li><a href="admin_modify.htm">修改報名資料</a></li>
				<li><a href="user.htm">登出</a></li>
			</ul>
			<a href="#my-id" class="uk-navbar-toggle uk-visible-small" data-uk-offcanvas="{mode:'slide'}">開啟選單 </a>
		</nav>
		
		<div id="my-id" class="uk-offcanvas">
			<div class="uk-offcanvas-bar">
				<ul id="navUL" class="uk-navbar-nav">
					<li style="width:100%;"><a href="admin.htm">管理中心首頁</a></li>
					<li style="width:100%;"><a href="admin_unfill.htm">尚未填寫匯款資料的隊伍</a></li>
					<li style="width:100%;"><a href="admin_wait.htm">正在等候審核的隊伍</a></li>
					<li style="width:100%;"><a href="admin_duplicate.htm">重複報名名單</a></li>
					<li class="uk-active" style="width:100%;"><a href="admin_accepted.htm">已通過審核的隊伍</a></li>
					<li style="width:100%;"><a href="admin_chart.htm">報名狀況報表</a></li>
					<li style="width:100%;"><a href="admin_modify.htm">修改報名資料</a></li>
					<li style="width:100%;"><a href="user.htm">登出</a></li>
				</ul>
			</div>
		</div>
		
		<div class="uk-block uk-width-medium-1-1 uk-container-center">
			<hr/>
			<h2 style="margin-left:5%;">已通過審核的球隊</h2>
			
			<span class="loading-use-flexbox" id="loading-list"><div class="loadingImg"></div></span>
			
			<div id="list" style="display:none;" class="uk-overflow-container">
				<table id="tableList" style="width: 90%; margin-left:5%;margin-top:20px;line-height:16pt;" class="fancytable uk-table-condensed uk-text-nowrap">
					<tr class="headerrow" id="trHead">
						<td>序號</td>
						<td>球隊</td>
						<td>聯絡人</td>
						<td>連絡電話</td>
						<td>Line ID</td>
						<td>組別</td>
						<td>預賽無法初賽日期</td>
						<td>詳細資料</td>
					</tr>
				</table>
				<div style="text-align:center;">
					<a id="list-pre"  class="button button-rounded button-flat-caution" href="javascript:;">上一頁</a>
					<a id="list-next" class="button button-rounded button-flat-caution" href="javascript:;">下一頁</a>
				</div>
			</div>
		</div>
	</div>
	
	<div id="divGen" class="uk-width-medium-4-5 uk-container-center main" style="font-size:16pt;display:none;background-color:rgb(240,240,240); margin-top:20px;">
		<h2 style="margin-left:5%;">下載或列印所有報名表</h2>
		<br/><br/>
		<p style="text-align:center;">
			若您需要列印所有通過審核的隊伍資料，您可以點選「產生報名總表」。
			系統將會自動合併所有報名表，並且生成一個pdf檔。
		</p>
		<div class="use-flexbox"><p style="line-height:28pt;">
			使用說明 : 
			<br/>按下「產生報名總表」後，系統會自動選擇產生一份新的報名總表，或是直接回傳最近生成的報名總表。
			<br/><b>如果您想確保產生的報名總表完全符合資料庫中的資料(供正式時使用)，請您勾選「強制生成新文件」。</b>
			<br/><span style="color:red;">請注意，產生報名總表會<b>大量消耗伺服器資源</b>進而影響報名，因此建議在報名離峰時段使用。</span>
		</p></div>
		<p id="BtnForm" style="text-align:center;line-height:24pt;">
			<label><input type="checkbox" style="margin-left:10px" id="force" name="force" value="true"> 強制生成新文件</label><br/>
			<a id="generatePDF"  class="button button-rounded button-flat-caution" href="javascript:;">產生報名總表</a>
		</p>
		<div id="showArea" style="text-align:center;">
			
		</div>
		<div id="linkArea" style="display:none;text-align:center;">
			<a href="#" target="_blank" class="button button-rounded button-flat-caution" id="downloadAll"><i class="uk-icon-cloud-download"></i> 下載pdf檔</a>
			<a href="#" target="_blank" class="button button-rounded button-flat-caution" id="viewAll"><i class="uk-icon-google"></i> 在Google雲端硬碟中檢視</a>
		</div>
	</div>
</div>

<div class="tm-footer" style="background-color:rgb(90,90,90); margin-top:20px;">
	<div class="uk-container uk-container-center uk-text-center">
		<div class="uk-panel">
			
		</div>
		<ul class="uk-subnav uk-subnav-line uk-flex-center subnavStyle" style="margin-top:30px;">
			<li>Copyright 2017 Li-Xain Chen. All rights reserved.</li>
		</ul>
	</div>
</div>

<script language="javascript">
	$(document).ready(function(){
		appStart();
	});
	
	function gapiLoaded(){
		if (auth2.isSignedIn.get()) {
			$("#unLogin").hide();
			$("#isLogin").show();
			$("#divGen").show();
			var profile = auth2.currentUser.get().getBasicProfile();
			console.log('ID: ' + profile.getId());
			console.log('Full Name: ' + profile.getName());
			console.log('Given Name: ' + profile.getGivenName());
			console.log('Family Name: ' + profile.getFamilyName());
			console.log('Image URL: ' + profile.getImageUrl());
			console.log('Email: ' + profile.getEmail());
			
			var id_token = googleUser.Zi.id_token;
			
			function getData(page){
				$("div#list").fadeOut(100);
				$("span#loading-list").fadeIn(100);
				
				var dataObj = new Object();
				
				page = parseInt(page);
				dataObj.mode = "admin-accepted";
				dataObj.token = id_token;
				dataObj.page = page+"";
				
				//console.log(id_token);
				
				$.get("https://script.google.com/macros/s/AKfycbzG5omXeexMerKEDVPaAbe2zzzE7tmOvkw5JboMb2GIYrGrhg8/exec", 
					dataObj,
				function (result) {
					console.log(dataObj);
					//$("span#login").css("display", "none");
					if(result == "false"){
						alert("系統發生錯誤!");
						document.location.href="index.htm";
					}else{
						$(".datarowodd, .dataroweven").remove();
						var json = $.parseJSON(result);
						$("span#teamAmount").text(json.teamAmount);
						var data = json.list;
						for(var i in data){
							var idArray = data[i][13].split("_");
							var idHtml = idArray[0] + "_" + idArray[1] + "_" + idArray[2] + "_" + "<span style='color:red;'>" + idArray[3] + "</span>" + "_" + idArray[4];
							var css = ((i % 2) == 0)? "datarowodd" : "dataroweven";
							var html = '<tr class="'+css+'">';
							html += '<td>' + idHtml + '</td>';
							html += '<td>' + data[i][1] + '</td>';
							html += '<td>' + data[i][5] + '</td>';
							html += '<td>' + data[i][6] + '</td>';
							html += '<td>' + data[i][7] + '</td>';
							html += '<td>' + data[i][2] + '</td>';
							html += '<td>' + data[i][10] + '</td>';
							html += '<td><a href="https://docs.google.com/document/d/' + data[i][14] + '/edit?usp=drivesdk" target="_blank" class="button button-rounded button-flat-caution" id="view"><i class="uk-icon-google"></i> 開啟</a></td>';
							html += '</tr>';
							$("table#tableList").append(html);
						}
						
						if(data.length <= 0){
							var html = '<td colspan="7" style="text-align:center;font-size:14px;">目前沒有隊伍!</td>';
							$("table#tableList").append(html);
						}
						
						if(page > 1){
							$("a#list-pre").css("display", "");
						}else{
							$("a#list-pre").css("display", "none");
						}
						
						console.log(json.hasNextPage);
						
						if(json.hasNextPage){
							$("a#list-next").css("display", "");
						}else{
							$("a#list-next").css("display", "none");
						}
						$("span#loading-list").fadeOut(100);
						$("div#list").fadeIn(100);
					}
				});
			}
			
			var page = 1;
			getData(page);
			
			$("a#list-pre").click(function(){
				page--;
				getData(page);
			});
			
			$("a#list-next").click(function(){
				page++;
				getData(page);
			});
			
		}else{
			document.location.href="login.htm";
		}
		
		$("a#generatePDF").click(function(){
			$("#BtnForm").fadeOut(500);
			$("#showArea").text("請稍候...這可能會花上一段時間");
			var checkbox = $("#force").prop("checked");
			var dataObjx = new Object();
			var id_token = googleUser.Zi.id_token;
			dataObjx.force = checkbox + "";
			dataObjx.token = id_token;
			
			console.log(checkbox);
			$.get("https://script.google.com/macros/s/AKfycbzasub1a12mCMH8RYerz_e-IiTe7ALhh6zxUBDYQfoHS8b4yLI/exec", 
					dataObjx,
					function (result) {
						$("#showArea").html("");
						console.log(result);
						var json = jQuery.parseJSON(result);
						if(json.stat == "false"){
							alert("系統發生錯誤!");
							window.top.location.href = "./"; 
							return;
						}
						$("a#viewAll").attr("href", json.url);
						$("a#downloadAll").attr("href", json.dlPDF);
						$("#linkArea").fadeIn(500);
					}
			);
		});
	}
</script>

</body>

</html>